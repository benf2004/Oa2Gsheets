<!DOCTYPE html>
<html>
<head>
    <title>Google Sheets Integration</title>
    <meta charset="utf-8" />
    <!-- load jQuery -->
    <script async defer type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <link rel="stylesheet" href="redips_table/style.css" type="text/css" media="screen" />
    <!-- REDIPS.drag -->
    <script type="text/javascript" src="redips_table/redips-drag-source.js"></script>
    <!-- local script -->
    <script type="text/javascript" src="redips_table/script.js"></script>
    <script type="text/javascript" src="picker.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
</head>
<body>
<nav>
    <a href="index.html">Sign In</a>
    <a href="input.html">Input Box</a>
    <a href="picker.html">Pick Spreadsheet</a>
    <br/>
</nav>
<button onclick="saveTable()">Save Table</button>

<!--Add buttons to initiate auth sequence and sign out-->
<button id="authorize_button" onclick="handleAuthClick()">Pick Spreadsheet</button>
<button id="signout_button" onclick="handleSignoutClick()">Sign Out</button>

<pre id="content" style="white-space: pre-wrap;"></pre>

<div id="redips-drag">
    <table id="tab">
        <colgroup>
            <col class="a">
            <col class="b">
            <col class="c">
            <col class="d">
            <col class="e">
            <col class="f">
            <col class="g">
            <col class="h">
            <col class="i">
            <col class="j">
            <col class="k">
            <col class="l">
            <col class="m">
            <col class="n">
            <col class="o">
            <col class="p">
            <col class="q">
            <col class="r">
            <col class="s">
            <col class="t">
            <col class="u">
            <col class="v">
            <col class="w">
            <col class="x">
            <col class="y">
            <col class="z">
        </colgroup>
        <tbody>
        <tr>
            <td class="redips-mark">A</td>
            <td class="redips-mark">B</td>
            <td class="redips-mark">C</td>
            <td class="redips-mark">D</td>
            <td class="redips-mark">E</td>
            <td class="redips-mark">F</td>
            <td class="redips-mark">G</td>
            <td class="redips-mark">H</td>
            <td class="redips-mark">I</td>
            <td class="redips-mark">J</td>
            <td class="redips-mark">K</td>
            <td class="redips-mark">L</td>
            <td class="redips-mark">M</td>
            <td class="redips-mark">N</td>
            <td class="redips-mark">O</td>
            <td class="redips-mark">P</td>
            <td class="redips-mark">Q</td>
            <td class="redips-mark">R</td>
            <td class="redips-mark">S</td>
            <td class="redips-mark">T</td>
            <td class="redips-mark">U</td>
            <td class="redips-mark">V</td>
            <td class="redips-mark">W</td>
            <td class="redips-mark">X</td>
            <td class="redips-mark">Y</td>
            <td class="redips-mark">Z</td>
        </tr>
        <tr>
            <td class="redips"><div id="date" class="redips-drag">Date</div></td>
            <td class="redips"><div id="asin" class="redips-drag">ASIN</div></td>
            <td class="redips"><div id="title" class="redips-drag">Product Name</div></td>
            <td class="redips"><div id="roi" class="redips-drag">ROI</div></td>
            <td class="redips"><div id="sr" class="redips-drag">Sales Rank</div></td>
            <td class="redips"><div id="cat_name" class="redips-drag">Category name</div></td>
            <td class="redips"><div id="source_url" class="redips-drag">Source URL</div></td>
            <td class="redips"><div id="cogs" class="redips-drag">COGS</div></td>
            <td class="redips"><div id="price" class="redips-drag">Price</div></td>
            <td class="redips"><div id="profit" class="redips-drag">Profit</div></td>
            <td class="redips"><div id="ref_per" class="redips-drag">Referral %</div></td>
            <td class="redips"><div id="notes" class="redips-drag">Notes</div></td>
            <td class="redips"><div id="ref_fee" class="redips-drag">Referral Fee ($)</div></td>
            <td class="redips"><div id="ship" class="redips-drag">Shipping</div></td>
            <td class="redips"><div id="tot_fee" class="redips-drag">Total Fee</div></td>
            <td class="redips"><div id="sell_link" class="redips-drag">Seller link</div></td>
            <td class="redips"></td>
            <td class="redips"></td>
            <td class="redips"></td>
            <td class="redips"></td>
            <td class="redips"></td>
            <td class="redips"></td>
            <td class="redips"></td>
            <td class="redips"></td>
            <td class="redips"></td>
            <td class="redips"></td>
        </tr>
        </tbody>
    </table>

    <table class="other_columns">
        </tbody>
            <tr>
                <td>
                    <div class="redips-drag" id="margin">Gross Margin</div>
                    <div class="redips-drag" id="other_fees">Other Fees</div>
                    <div class="redips-drag" id="sales_tax">Sales Tax</div>
                    <div class="redips-drag" id="proceeds">Seller Proceeds</div>
                    <div class="redips-drag">test</div>
                    <div class="redips-drag"></div>
                    <div class="redips-drag"></div>
                    <div class="redips-drag"></div>
                </td>
            </tr>
        <tbody>
    </table>

    <!-- here will be new table loaded -->
    <span id="load_content"/>
</div>
<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
<script type="text/javascript">
    /* exported gapiLoaded */
    /* exported gisLoaded */
    /* exported handleAuthClick */
    /* exported handleSignoutClick */

    // Authorization scopes required by the API; multiple scopes can be
    // included, separated by spaces.
    const SCOPES = 'https://www.googleapis.com/auth/drive.file profile';

    const CLIENT_ID = '654389885336-re4m337upgk4igdbu3q4jab9id3sp2qd.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyAPnD47lfv1T5oHMAC770fUmSmSiKe9J3w';

    // TODO(developer): Replace with your own project number from console.developers.google.com.
    const APP_ID = '654389885336';

    let tokenClient;
    let accessToken = null;
    let pickerInited = false;
    let gisInited = false;


    document.getElementById('authorize_button').style.visibility = 'hidden';
    document.getElementById('signout_button').style.visibility = 'hidden';

    /**
     * Callback after api.js is loaded.
     */
    function gapiLoaded() {
        gapi.load('picker', intializePicker);
    }

    /**
     * Callback after the API client is loaded. Loads the
     * discovery doc to initialize the API.
     */
    function intializePicker() {
        pickerInited = true;
        maybeEnableButtons();
    }

    /**
     * Callback after Google Identity Services are loaded.
     */
    function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: '', // defined later
        });
        gisInited = true;
        maybeEnableButtons();
    }

    /**
     * Enables user interaction after all libraries are loaded.
     */
    function maybeEnableButtons() {
        if (pickerInited && gisInited) {
            document.getElementById('authorize_button').style.visibility = 'visible';
        }
    }

    /**
     *  Sign in the user upon button click.
     */
    function handleAuthClick() {
        tokenClient.callback = async (response) => {
            if (response.error !== undefined) {
                throw (response);
            }
            accessToken = response.access_token;
            document.getElementById('signout_button').style.visibility = 'visible';
            document.getElementById('authorize_button').innerText = 'Refresh';
            await createPicker();
        };

        if (accessToken === null) {
            // Prompt the user to select a Google Account and ask for consent to share their data
            // when establishing a new session.
            tokenClient.requestAccessToken({prompt: 'consent'});
        } else {
            // Skip display of account chooser and consent dialog for an existing session.
            tokenClient.requestAccessToken({prompt: ''});
        }
    }

    /**
     *  Sign out the user upon button click.
     */
    function handleSignoutClick() {
        if (accessToken) {
            accessToken = null;
            google.accounts.oauth2.revoke(accessToken);
            document.getElementById('content').innerText = '';
            document.getElementById('authorize_button').innerText = 'Authorize';
            document.getElementById('signout_button').style.visibility = 'hidden';
        }
    }

    /**
     *  Create and render a Picker object for searching images.
     */
    function createPicker() {
        const view = new google.picker.View(google.picker.ViewId.DOCS);
        view.setMimeTypes("application/vnd.google-apps.spreadsheet");
        const picker = new google.picker.PickerBuilder()
            .enableFeature(google.picker.Feature.NAV_HIDDEN)
            .setDeveloperKey(API_KEY)
            .setAppId(APP_ID)
            .setOAuthToken(accessToken)
            .addView(view)
            .addView(new google.picker.DocsUploadView())
            .setCallback(pickerCallback)
            .build();
        picker.setVisible(true);
    }

    /**
     * Displays the file details of the user's selection.
     * @param {object} data - Containers the user selection from the picker
     */
    function pickerCallback(data) {
        if (data.action == google.picker.Action.PICKED) {
            var fileId = data.docs[0].id;
            document.cookie = "fileID=" + fileId + "; expires=Wed, 26 April 2062 12:00:00 UTC; domain=oa2gsheets.com";
        }
    }
</script>
</body>
</html>